#!/usr/bin/env node
'use strict';

// Ping graphing tool:
// pingg google.com yahoo.com

const Config = require('bcfg');
const blessed = require('blessed');
const contrib = require('blessed-contrib');
const cp = require('child_process');

// Parse arguments
const config = new Config('pingg', {
	alias: {
		'c': 'colors',
		'f': 'flood',
		'A': 'flood',
		't': 'trace',
	},
});

config.inject({
	'colors': ['green', 'blue', 'red', 'white', 'yellow', 'magenta'],
});

config.load({ argv: true });
config.argv = config.argv.length && config.argv || ['8.8.8.8', '1.1.1.1'];
if (config.bool('trace')) {
	config.argv = cp.execSync('traceroute '+config.argv[0])
		.toString().split('\n').reduce((arr, s) => {
			const e = / \(([\w.]+)\) /.exec(s);
			e && e[1] && arr.push(e[1]);
			return arr;
		}, []);
}

const colors = config.array('colors');
const data = [];
let cIndex = 0;

// Setup display
const screen = blessed.screen();
const line = contrib.line({
	xLabelPadding: 3,
	xPadding: 5,
	yLabelPadding: 1,
	yPadding: 1,
	showLegend: true,
	label: 'Network latency',
});
screen.append(line);
screen.key(['escape', 'q', 'C-c'], function(ch, key) {
	return process.exit(0);
});
screen.render();

// Ping each host and display results
for (const host of config.argv) {
	const ping = cp.spawn('ping', [host].concat(
		config.bool('flood') && ['-A'] || []));
	const hostData = {
		title: host,
		x:[],
		y:[],
		style: {
			line: colors[cIndex++ % colors.length],
		},
	};
	data.push(hostData);

	ping.stdout.on('data', function(d) {
		// console.log("DATA!!!", d.toString())
		const latency = (/time=([\d\.]+) ms/g).exec(d.toString());
		if (latency) {
			hostData.x.push((new Date()).toLocaleTimeString());
			hostData.y.push(parseFloat(latency[1]));
			line.setData(data);
			screen.render();
		}
	});

	ping.stdout.on('end', function() {
		hostData.title = '!! ' + host;
	});

	// Ctrl-z will stop without exiting
	screen.key(['C-z'], function() {
		ping.kill();
	});
}
